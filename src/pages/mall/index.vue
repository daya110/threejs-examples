<template>
    <div class="container">
        <div class="from"><a href="https://github.com/luosijie/threejs-examples/tree/master/mall">项目地址</a></div>
        <canvas id="canvas"></canvas>
        <div class="svg-container">
            <svg id="svg_shapes" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="90 0 600 560">
                <path name="麦当劳" id="svg_4" d="m201.90463,23.01591l65.87312,0l0,47.61912l-65.87312,0l0,-47.61912z" stroke-opacity="null" stroke-linecap="null" stroke-linejoin="null" stroke-width="1.5" stroke="null" fill="#3f7f00" />
                <path name="麦当劳" id="svg_5" d="m130.47595,235.71465l94.44459,0l0,42.06355l-94.44459,0l0,-42.06355z" stroke-opacity="null" stroke-linecap="null" stroke-linejoin="null" stroke-width="1.5" stroke="null" fill-opacity="null" fill="#3f7f00" />
                <path name="麦当劳" id="svg_6" d="m129.6823,182.53996l84.12711,0l0,41.2699l-84.12711,0l0,-41.2699z" stroke-opacity="null" stroke-linecap="null" stroke-linejoin="null" stroke-width="1.5" stroke="null" fill-opacity="null" fill="#3f7f00" />
                <path name="麦当劳" id="svg_8" d="m214.80591,113.92551l32.77018,-32.77018l23.57026,23.57026l-32.77018,32.77018l-23.57026,-23.57026z" stroke-opacity="null" stroke-linecap="null" stroke-linejoin="null" stroke-width="1.5" stroke="null" fill-opacity="null" fill="#3f7f00" />
                <path name="麦当劳" id="svg_9" d="m242.58371,140.11603l32.77018,-32.77018l23.57026,23.57026l-32.77018,32.77018l-23.57026,-23.57026z" stroke-opacity="null" stroke-linecap="null" stroke-linejoin="null" stroke-width="1.5" stroke="null" fill-opacity="null" fill="#3f7f00" />
                <path name="麦当劳" id="svg_10" d="m264.80595,79.79849l48.2464,-48.2464l15.23692,15.23692l-48.2464,48.2464l-15.23692,-15.23692z" stroke-opacity="null" stroke-linecap="null" stroke-linejoin="null" stroke-width="1.5" stroke="null" fill-opacity="null" fill="#3f7f00" />
                <path name="麦当劳" id="svg_11" d="m282.2663,98.84614l48.2464,-48.2464l15.23692,15.23692l-48.2464,48.2464l-15.23692,-15.23692z" stroke-opacity="null" stroke-linecap="null" stroke-linejoin="null" stroke-width="1.5" stroke="null" fill-opacity="null" fill="#3f7f00" />
                <path name="麦当劳" id="svg_12" d="m302.90125,118.68745l48.2464,-48.2464l15.23692,15.23692l-48.2464,48.2464l-15.23692,-15.23692z" stroke-opacity="null" stroke-linecap="null" stroke-linejoin="null" stroke-width="1.5" stroke="null" fill-opacity="null" fill="#3f7f00" />
                <path name="麦当劳" id="svg_13" d="m324.32987,140.11605l48.2464,-48.2464l15.23692,15.23692l-48.2464,48.2464l-15.23692,-15.23692z" stroke-opacity="null" stroke-linecap="null" stroke-linejoin="null" stroke-width="1.5" stroke="null" fill-opacity="null" fill="#3f7f00" />
                <path name="麦当劳" id="svg_14" d="m129.6823,139.68275l39.6826,0l0,34.12704l-39.6826,0l0,-34.12704z" stroke-opacity="null" stroke-linecap="null" stroke-linejoin="null" stroke-width="1.5" stroke="null" fill="#bf005f" />
                <path name="麦当劳" id="svg_15" d="m175.7141,139.68275l37.30164,0l0,34.12704l-37.30164,0l0,-34.12704z" stroke-opacity="null" stroke-linecap="null" stroke-linejoin="null" stroke-width="1.5" stroke="null" fill="#007f3f" />
                <path name="麦当劳" id="svg_16" d="m274.12698,175.39709l46.03181,0l0,26.98417l-46.03181,0l0,-26.98417z" stroke-opacity="null" stroke-linecap="null" stroke-linejoin="null" stroke-width="1.5" stroke="null" fill="#7f003f" />
                <path name="麦当劳" id="svg_17" d="m137.23366,49.58187l47.23197,47.23197l-21.46164,21.46164l-47.23197,-47.23197l21.46164,-21.46164z" stroke-opacity="null" stroke-linecap="null" stroke-linejoin="null" stroke-width="1.5" stroke="null" fill="#7f003f" />
                <path name="麦当劳" id="svg_18" d="m336.03183,205.55586l69.04772,0l0,31.74608l-69.04772,0l0,-31.74608z" stroke-opacity="null" stroke-linecap="null" stroke-linejoin="null" stroke-width="1.5" stroke="null" fill="#5656ff" />
                <path name="麦当劳" id="svg_19" d="m336.03183,274.60361l69.04772,0l0,20.63496l-69.04772,0l0,-20.63496z" stroke-opacity="null" stroke-linecap="null" stroke-linejoin="null" stroke-width="1.5" stroke="null" fill="#5656ff" />
                <path name="麦当劳" id="svg_20" d="m336.03183,305.42343l69.04772,0l0,74.60332l-69.04772,0l0,-74.60332z" stroke-opacity="null" stroke-linecap="null" stroke-linejoin="null" stroke-width="1.5" stroke="null" fill="#007f3f" />
                <path name="麦当劳" id="svg_21" d="m155.48768,30.53422l47.23197,47.23197l-15.11243,15.11243l-47.23197,-47.23197l15.11243,-15.11243z" stroke-opacity="null" stroke-linecap="null" stroke-linejoin="null" stroke-width="1.5" stroke="null" fill="#7f003f" />
                <path name="麦当劳" id="svg_23" d="m337.61912,200.0003c0,0 66.66677,0 66.66677,0c0,0 2.38096,-71.42868 2.38096,-71.42868c0,0 -23.02959,0 -23.33294,0c0.30335,0 -31.82833,32.93901 -32.53973,31.74608c0.15812,0.63553 -13.26811,0.79365 -13.49208,0c0.10362,0 0.31703,39.6826 0.31703,39.6826z" stroke-opacity="null" stroke-width="1.5" stroke="null" fill="#bf5f00" />
                <path name="麦当劳" id="svg_25" d="m279.68253,216.67462l38.88895,0l0,64.28581l-38.88895,0l0,-64.28581z" stroke-opacity="null" stroke-linecap="null" stroke-linejoin="null" stroke-width="1.5" stroke="null" fill="#7f003f" />
                <path name="麦当劳" id="svg_26" d="m293.96826,293.91617l26.19052,0l0,46.82546l-26.19052,0l0,-46.82546z" stroke-opacity="null" stroke-linecap="null" stroke-linejoin="null" stroke-width="1.5" stroke="null" fill="#7f003f" />
            </svg>
        </div>
    </div>
</template>
<script>
export default {
    name: 'HelloWorld',
    data() {
        return {}
    },
    methods: {
        init() {

        }
    },
    mounted() {
        var camera, scene, raycaster, renderer;
        var mouse = new THREE.Vector2(), // 二维坐标用来转化鼠标参数
            INTERSECTED; // 被选中的物体
        var mall = new THREE.Object3D(); // 建一个空对象用来放场景物体

        init();
        buildLightSystem();
        buildAuxSystem();
        buildMall();
        loop();
        addLabel()

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);
            // 初始化相机配置
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 1, 10000);
            camera.position.set(300, 300, 300);
            camera.lookAt(scene.position);
            raycaster = new THREE.Raycaster();
            // 初始化
            renderer = new THREE.WebGLRenderer();
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            document.addEventListener('mousemove', onDocumentMouseMove, false);
            window.addEventListener('resize', onWindowResize, false);
        }

        /**
         * 构建商场建筑
         **/
        function buildMall() {
            // 获取html中的svg地图路径
            var svgShapes = document.querySelector('#svg_shapes')
            var paths = svgShapes.querySelectorAll('path')
            for (var i = 0; i < paths.length; i++) {
                var d = paths[i].getAttribute('d')
                // 使用插件将svg路径转化为THREE.js形状
                var shape = transformSVGPathExposed(d)
                // 将形状挤出
                var svgGeometry = new THREE.ExtrudeGeometry(shape, {
                    amount: 25,
                    stes: 1,
                    bevelEnabled: false
                })
                // 由于平面转3D是竖直方向的, 需要旋转为水平方向
                svgGeometry.rotateX(Math.PI / 2)
                // 获取svg平面图每个模块对应的颜色
                var color = paths[i].getAttribute('fill')
                var svgMaterial = new THREE.MeshPhongMaterial({ color: color, shininess: 100 })
                var svgMesh = new THREE.Mesh(svgGeometry, svgMaterial)
                svgMesh.name = paths[i].getAttribute('name')
                mall.add(svgMesh)
            }
            mall.translateX(-200)
            mall.translateZ(-200)
            mall.translateY(25)
            scene.add(mall)
        }
        /**
         * 添加每个店面的标签: 暂时用小方块代替
         **/
        function addLabel() {
            var material = new THREE.MeshPhongMaterial({ color: 0x000000 })
            // 遍历场景中的元素, 在元素上方添加方块: 未来添加具体标签
            mall.children.forEach(elem => {
                var geometry = new THREE.BoxGeometry(2, 20, 2)
                var Mesh = new THREE.Mesh(geometry, material);
                Mesh.position.y = 30
                console.log(elem)
                Mesh.position.x = elem.geometry.boundingSphere.center.x - 200
                Mesh.position.z = elem.geometry.boundingSphere.center.z - 200
                scene.add(Mesh)
            })
        }
        /**
         * 辅助系统: 网格和坐标
         **/
        function buildAuxSystem() {
            var axisHelper = new THREE.AxesHelper(2000)
            scene.add(axisHelper)
            var gridHelper = new THREE.GridHelper(600, 60)
            scene.add(gridHelper)
            var controls = new THREE.OrbitControls(camera, renderer.domElement)
            controls.enableDamping = true
            controls.dampingFactor = 0.25
            controls.rotateSpeed = 0.35
        }
        /**
         * 光照系统
         **/
        function buildLightSystem() {

            var directionalLight = new THREE.DirectionalLight(0xffffff, 1.1);
            directionalLight.position.set(300, 1000, 500);
            directionalLight.target.position.set(0, 0, 0);
            directionalLight.castShadow = true;

            var d = 300;
            directionalLight.shadow.camera = new THREE.OrthographicCamera(-d, d, d, -d, 500, 1600);
            directionalLight.shadow.bias = 0.0001;
            directionalLight.shadow.mapSize.width = directionalLight.shadow.mapSize.height = 1024;
            scene.add(directionalLight)

            var light = new THREE.AmbientLight(0xffffff, 0.6)
            scene.add(light)

        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onDocumentMouseMove(event) {
            event.preventDefault();
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        }

        function loop() {
            requestAnimationFrame(loop);
            render();
        }

        function render() {
            // 鼠标位置向摄像机位置发射一条射线
            raycaster.setFromCamera(mouse, camera);
            // 设置射线影响的范围
            var intersects = raycaster.intersectObjects(mall.children);
            if (intersects.length > 0) {
                if (INTERSECTED != intersects[0].object) {
                    if (INTERSECTED) INTERSECTED.material.emissive.setHex(INTERSECTED.currentHex);
                    INTERSECTED = intersects[0].object;
                    INTERSECTED.currentHex = INTERSECTED.material.emissive.getHex();
                    INTERSECTED.material.emissive.setHex(0xff0000);
                }
            } else {
                if (INTERSECTED) INTERSECTED.material.emissive.setHex(INTERSECTED.currentHex);
                INTERSECTED = null;
            }
            renderer.render(scene, camera);
        }
    }
}

</script>
<!-- Add "scoped" attribute to limit CSS to this component only -->
<style lang="scss" scoped>
.container {
    margin: 20px 0;
    position: absolute;
    text-align: center;
    /*opacity: 0.2;*/
    width: 100%;
}

.info a {
    display: block;
    font-size: 16px;
    line-height: 28px;
    color: #ffffff;
    text-decoration: none;
}

a.title {
    font-size: 20px;
    font-weight: bold;
}

.svg-container {
    position: absolute;
    top: 10px;
    left: 10px;
    background: white;
    width: 240px;
    height: 300px;
    overflow: hidden;
    border: 1px solid #f2f2f2;
    overflow: hidden;
    border-radius: 6px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
}

.svg-container svg {
    position: absolute;
    top: 100px;
    left: 90px;
    transform: scale(1.8);
}

.from {
    position: absolute;
    width: 100%;
    text-align: center;
    top: 0;
}

.from a {
    color: black;
}

</style>
